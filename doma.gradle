/*
 * DB接続定義
 */
def genUrl                       = 'jdbc:mysql://localhost:3306/mmsdb'
def genUser                      = 'mms01'
def genPassword                  = 'mms01'
def genTableTypes                = 'TABLE, VIEW'
def genTemplatePrimaryDir        = 'domaGenTemplates'
def genVersionColumnNamePattern  = 'version'
//def genSqlFilePattern            = 'META-INF/**/*.sql'

/*
 * 共通ソースコード自動生成
 */
task domaGen << {
    // entity
    def entityPackageName        = 'rms.domain.com.entity'
    def entityOverwrite          = true
    def entityOverwriteListener  = true
    def entityUseAccessor        = true
//    def entitySuperclassName     = 'rms.com.abstracts.AbstractEntity'
    // dao
    def daoPackageName           = 'rms.domain.com.repository'
    def daoOverwrite             = true
    // sql
    def SqlOverwrite             = true

    ant.taskdef(resource: 'domagentask.properties', classpath: configurations.domaGenRuntime.asPath)
    ant.gen(url: genUrl,
            user: genUser,
            password: genPassword,
            tableTypes: genTableTypes,
            templatePrimaryDir: genTemplatePrimaryDir,
            versionColumnNamePattern: genVersionColumnNamePattern) {
        entityConfig(packageName: entityPackageName,
                     overwrite: entityOverwrite,
                     overwriteListener: entityOverwriteListener,
//                     superclassName: entitySuperclassName,
                     useAccessor: entityUseAccessor)
        daoConfig(packageName: daoPackageName, overwrite: daoOverwrite)
        sqlConfig(overwrite: SqlOverwrite)
    }
}

/*
 * 個別ソースコード自動生成
 */
task domaGenEntity << {
    def entityPackageName = 'example'
    def entityEntityName  = 'Example'
    def entityOverwrite   = true
    def entityUseAccessor = true
    def entitySql         =
'''
select
	u.user_id
	,u.user_nm
	,u.email
	,mr1.role_nm as role_nm1
	,mr2.role_nm as role_nm2
	,mr3.role_nm as role_nm3
from
	m_user u
	left join v_m_user_role mr1
		on u.user_id = mr1.user_id
		and mr1.role_id = 1
	left join v_m_user_role mr2
		on u.user_id = mr2.user_id
		and mr2.role_id = 2
	left join v_m_user_role mr3
		on u.user_id = mr3.user_id
		and mr3.role_id = 3
'''

    ant.taskdef(resource: 'domagentask.properties', classpath: configurations.domaGenRuntime.asPath)
    ant.gen(url: genUrl,
            user: genUser,
            password: genPassword,
            tableTypes: genTableTypes,
            templatePrimaryDir: genTemplatePrimaryDir) {
        entityConfig(packageName: entityPackageName,
                     entityName: entityEntityName,
                     overwrite: entityOverwrite,
                     useAccessor: entityUseAccessor,
                     sql: entitySql)
    }
}